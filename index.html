<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ShiftTrack ‚Äî Daily Work Timer</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg: #f1f5f9;
    --surface: #ffffff;
    --surface2: #f8fafc;
    --border: #e2e8f0;
    --border2: #cbd5e1;
    --accent: #6366f1;
    --accent-light: #eef2ff;
    --accent2: #ef4444;
    --accent2-light: #fef2f2;
    --accent3: #10b981;
    --accent3-light: #ecfdf5;
    --warn: #f59e0b;
    --warn-light: #fffbeb;
    --text: #0f172a;
    --text2: #334155;
    --muted: #94a3b8;
    --radius: 12px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow: 0 4px 16px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.05);
    --shadow-lg: 0 10px 40px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.05);
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
  .container { max-width: 960px; margin: 0 auto; padding: 0 20px 120px; }

  /* Header */
  header { padding: 28px 0 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; border-bottom: 1px solid var(--border); margin-bottom: 28px; }
  .brand { display: flex; align-items: center; gap: 12px; }
  .brand-icon { width: 40px; height: 40px; background: var(--accent); border-radius: 10px; display: grid; place-items: center; font-size: 20px; box-shadow: 0 2px 8px rgba(99,102,241,0.3); }
  .brand h1 { font-size: 1.4rem; font-weight: 700; letter-spacing: -0.5px; color: var(--text); }
  .brand h1 span { color: var(--accent); }
  .subtitle { font-family: 'Space Mono', monospace; font-size: 0.62rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-top: 2px; }
  .shift-clock { text-align: right; }
  .clock-time { font-family: 'Space Mono', monospace; font-size: 1.7rem; font-weight: 700; color: var(--text); letter-spacing: 1px; line-height: 1; }
  .clock-label { font-size: 0.6rem; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-top: 4px; }

  /* Shift Panel */
  .shift-panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px 24px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; box-shadow: var(--shadow-sm); }
  .shift-left { display: flex; align-items: center; gap: 28px; flex-wrap: wrap; }
  .shift-stats { display: flex; gap: 24px; flex-wrap: wrap; }
  .stat { text-align: center; }
  .stat-val { font-family: 'Space Mono', monospace; font-size: 1.1rem; font-weight: 700; color: var(--text); }
  .stat-lbl { font-size: 0.58rem; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-top: 2px; font-weight: 500; }
  .shift-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  .start-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
  .start-row label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 500; }
  .time-input { font-family: 'Space Mono', monospace; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.9rem; padding: 6px 12px; outline: none; width: 110px; transition: border-color 0.15s; }
  .time-input:focus { border-color: var(--accent); }

  /* Buttons */
  .btn { font-family: 'Inter', sans-serif; font-weight: 600; font-size: 0.78rem; letter-spacing: 0.3px; border: none; border-radius: 8px; padding: 9px 18px; cursor: pointer; transition: all 0.15s ease; display: inline-flex; align-items: center; gap: 6px; }
  .btn-primary { background: var(--accent); color: #fff; box-shadow: 0 2px 8px rgba(99,102,241,0.25); }
  .btn-primary:hover { background: #4f46e5; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(99,102,241,0.35); }
  .btn-secondary { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--border); }
  .btn-danger { background: var(--accent2-light); color: var(--accent2); border: 1px solid #fecaca; }
  .btn-danger:hover { background: #fee2e2; }
  .btn-success { background: var(--accent3); color: #fff; box-shadow: 0 2px 8px rgba(16,185,129,0.25); }
  .btn-success:hover { background: #059669; transform: translateY(-1px); }

  /* Progress */
  .progress-section { margin-bottom: 20px; }
  .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .progress-title { font-size: 0.65rem; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); font-weight: 500; }
  .progress-pct { font-family: 'Space Mono', monospace; font-size: 0.8rem; font-weight: 700; }
  .progress-track { height: 8px; background: var(--border); border-radius: 99px; overflow: hidden; }
  .progress-fill { height: 100%; border-radius: 99px; transition: width 0.5s cubic-bezier(0.34,1.56,0.64,1), background 0.3s; }
  .progress-fill.ok   { background: linear-gradient(90deg, #6366f1, #818cf8); }
  .progress-fill.warn { background: linear-gradient(90deg, #d97706, #f59e0b); }
  .progress-fill.over { background: linear-gradient(90deg, #dc2626, #ef4444); }

  /* Summary */
  .summary-panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px 24px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 20px; box-shadow: var(--shadow-sm); }
  .sum-item { text-align: center; }
  .sum-val { font-family: 'Space Mono', monospace; font-size: 1.4rem; font-weight: 700; line-height: 1; color: var(--text); }
  .sum-val.green { color: var(--accent3); }
  .sum-val.yellow { color: var(--warn); }
  .sum-val.red { color: var(--accent2); }
  .sum-val.blue { color: var(--accent); }
  .sum-lbl { font-size: 0.6rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-top: 6px; font-weight: 500; }
  .status-badge { display: inline-flex; align-items: center; gap: 5px; border-radius: 99px; padding: 5px 12px; font-size: 0.72rem; font-weight: 600; }
  .status-ok   { background: var(--accent3-light); color: var(--accent3); border: 1px solid #a7f3d0; }
  .status-warn { background: var(--warn-light); color: var(--warn); border: 1px solid #fde68a; }
  .status-over { background: var(--accent2-light); color: var(--accent2); border: 1px solid #fecaca; }

  /* Section title */
  .section-title { font-size: 0.62rem; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
  .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* Task Grid */
  .task-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .task-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow-sm); transition: box-shadow 0.2s, transform 0.15s, border-color 0.2s; position: relative; }
  .task-card:hover { box-shadow: var(--shadow); transform: translateY(-2px); border-color: var(--border2); }
  .task-card::before { content: ''; position: absolute; top: 0; left: 16px; right: 16px; height: 2px; background: var(--accent); border-radius: 0 0 3px 3px; opacity: 0; transition: opacity 0.2s; }
  .task-card:hover::before { opacity: 1; }
  .task-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  .task-name { font-size: 0.9rem; font-weight: 600; color: var(--text); }
  .task-rate { font-family: 'Space Mono', monospace; font-size: 0.65rem; background: var(--accent-light); color: var(--accent); border-radius: 6px; padding: 3px 8px; font-weight: 700; flex-shrink: 0; }
  .task-input-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
  .task-count-label { font-size: 0.62rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 500; white-space: nowrap; }
  .counter-widget { display: flex; align-items: center; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
  .counter-btn { background: var(--surface2); border: none; color: var(--accent); font-size: 1rem; font-weight: 700; width: 32px; height: 32px; cursor: pointer; transition: background 0.15s; display: grid; place-items: center; flex-shrink: 0; }
  .counter-btn:hover { background: var(--accent-light); }
  .counter-num { font-family: 'Space Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--text); width: 46px; text-align: center; background: #fff; border: none; outline: none; padding: 4px 0; }
  .counter-num::-webkit-outer-spin-button, .counter-num::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .counter-num[type=number] { -moz-appearance: textfield; }
  .task-result { display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid var(--border); }
  .task-mins { font-family: 'Space Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--accent); }
  .task-hrs { font-size: 0.68rem; color: var(--muted); margin-top: 2px; font-weight: 500; }
  .task-bar { height: 3px; background: var(--border); border-radius: 99px; margin-top: 10px; overflow: hidden; }
  .task-bar-fill { height: 100%; border-radius: 99px; background: var(--accent); transition: width 0.4s ease; }

  /* Auto-fill card (Inspection Review) */
  .auto-card { border-color: #c7d2fe; background: linear-gradient(135deg, #fff, #f5f3ff); }
  .auto-card:hover { border-color: var(--accent); }
  .auto-card::before { background: linear-gradient(90deg, var(--accent), #a78bfa); opacity: 1; }
  .auto-badge { font-size: 0.58rem; font-weight: 700; letter-spacing: 0.5px; background: var(--accent-light); color: var(--accent); border: 1px solid #c7d2fe; border-radius: 99px; padding: 2px 8px; vertical-align: middle; margin-left: 6px; }
  .auto-hint { font-size: 0.68rem; color: var(--accent); background: var(--accent-light); border-radius: 6px; padding: 5px 10px; margin-bottom: 10px; font-weight: 500; }
  .auto-widget { background: var(--accent-light); border-color: #c7d2fe; justify-content: space-between; padding: 0 10px; height: 34px; cursor: default; }
  .auto-icon { font-size: 0.9rem; color: var(--accent); }
  .auto-num { background: transparent; color: var(--accent); font-weight: 700; cursor: default; width: 40px; }
  .auto-tag { font-size: 0.6rem; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
  .auto-widget-editable { border-color: #c7d2fe; background: var(--accent-light); margin-bottom: 6px; }
  .auto-reset-row { display: flex; align-items: center; justify-content: space-between; }
  .auto-calc-info { font-size: 0.65rem; font-weight: 600; color: var(--accent); }
  .auto-reset-btn { font-size: 0.62rem; font-weight: 600; background: transparent; border: 1px solid #c7d2fe; color: var(--accent); border-radius: 6px; padding: 3px 10px; cursor: pointer; transition: all 0.15s; }
  .auto-reset-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }

  /* Actions */
  .action-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 28px; }

  /* History */
  .history-list { display: flex; flex-direction: column; gap: 8px; }
  .history-item { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; box-shadow: var(--shadow-sm); transition: box-shadow 0.15s; }
  .history-item:hover { box-shadow: var(--shadow); }
  .history-date { font-family: 'Space Mono', monospace; font-size: 0.7rem; color: var(--muted); }
  .history-tasks { display: flex; gap: 6px; flex-wrap: wrap; }
  .history-tag { background: var(--accent-light); color: var(--accent); border-radius: 99px; padding: 2px 10px; font-size: 0.65rem; font-weight: 600; }
  .history-total { font-family: 'Space Mono', monospace; font-size: 0.75rem; color: var(--accent3); font-weight: 700; }
  .history-del { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 0.9rem; transition: color 0.15s; padding: 2px 6px; border-radius: 4px; }
  .history-del:hover { color: var(--accent2); background: var(--accent2-light); }
  .empty-history { text-align: center; color: var(--muted); font-size: 0.8rem; padding: 32px; background: var(--surface); border: 1px dashed var(--border2); border-radius: var(--radius); }

  /* Bottom Bar */
  .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.94); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-top: 1px solid var(--border); z-index: 100; box-shadow: 0 -4px 24px rgba(0,0,0,0.06); }
  .bottom-bar-inner { max-width: 960px; margin: 0 auto; padding: 12px 20px; display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
  .bottom-left { min-width: 110px; }
  .bottom-label { font-size: 0.58rem; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 2px; font-weight: 500; }
  .countdown { font-family: 'Space Mono', monospace; font-size: 1.6rem; font-weight: 700; line-height: 1; }
  .countdown.ok   { color: var(--accent3); }
  .countdown.warn { color: var(--warn); }
  .countdown.over { color: var(--accent2); }
  .bottom-divider { width: 1px; height: 32px; background: var(--border); flex-shrink: 0; }
  .bottom-stat { text-align: center; }
  .bottom-stat-val { font-family: 'Space Mono', monospace; font-size: 0.9rem; font-weight: 700; color: var(--text); }
  .bottom-stat-lbl { font-size: 0.56rem; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-top: 2px; font-weight: 500; }
  .bottom-progress-wrap { flex: 1; min-width: 130px; }
  .bottom-progress-label { font-size: 0.58rem; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 5px; font-weight: 500; }
  .bottom-progress-track { height: 5px; background: var(--border); border-radius: 99px; overflow: hidden; }
  .bottom-progress-fill { height: 100%; border-radius: 99px; transition: width 1s linear, background 0.3s; }
  .bottom-progress-fill.ok   { background: linear-gradient(90deg, #6366f1, #818cf8); }
  .bottom-progress-fill.warn { background: linear-gradient(90deg, #d97706, #f59e0b); }
  .bottom-progress-fill.over { background: linear-gradient(90deg, #dc2626, #ef4444); }

  /* Toast */
  .toast { position: fixed; bottom: 80px; right: 24px; background: var(--text); color: #fff; border-radius: 10px; padding: 12px 20px; font-size: 0.8rem; font-weight: 500; z-index: 1000; transform: translateY(20px); opacity: 0; transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1); box-shadow: var(--shadow-lg); }
  .toast.show { transform: translateY(0); opacity: 1; }

  @media (max-width: 600px) {
    .clock-time { font-size: 1.2rem; }
    .countdown { font-size: 1.2rem; }
    .bottom-divider { display: none; }
    .bottom-bar-inner { gap: 12px; }
    .sum-val { font-size: 1.1rem; }
  }
</style>
</head>
<body>
<div class="container">

  <header>
    <div class="brand">
      <div class="brand-icon">‚è±</div>
      <div>
        <h1>Shift<span>Track</span></h1>
        <div class="subtitle">Daily Work Time Monitor</div>
      </div>
    </div>
    <div class="shift-clock">
      <div class="clock-time" id="liveClock">--:--:--</div>
      <div class="clock-label">Current Time</div>
    </div>
  </header>

  <div class="shift-panel">
    <div class="shift-left">
      <div class="shift-stats">
        <div class="stat"><div class="stat-val" id="statElapsed">0m</div><div class="stat-lbl">Elapsed</div></div>
        <div class="stat"><div class="stat-val" id="statRemain">420m</div><div class="stat-lbl">Remaining</div></div>
        <div class="stat"><div class="stat-val" id="statPct">0%</div><div class="stat-lbl">Used</div></div>
      </div>
    </div>
    <div>
      <div class="start-row">
        <label>Shift Start:</label>
        <input type="time" class="time-input" id="shiftStart" value="09:00"/>
      </div>
      <div class="shift-actions">
        <button class="btn btn-primary" id="btnStart" onclick="startShift()">‚ñ∂ Start Shift</button>
        <button class="btn btn-danger" id="btnReset" onclick="resetShift()" style="display:none">‚Ü∫ Reset</button>
      </div>
    </div>
  </div>

  <div class="progress-section">
    <div class="progress-header">
      <div class="progress-title">Task Load vs Shift Capacity (420 mins)</div>
      <div class="progress-pct" id="taskPct" style="color:var(--accent3)">0%</div>
    </div>
    <div class="progress-track">
      <div class="progress-fill ok" id="taskProgress" style="width:0%"></div>
    </div>
  </div>

  <div class="summary-panel">
    <div class="sum-item"><div class="sum-val blue" id="sumTasks">0</div><div class="sum-lbl">Total Tasks</div></div>
    <div class="sum-item"><div class="sum-val blue" id="sumMins">0</div><div class="sum-lbl">Total Mins</div></div>
    <div class="sum-item"><div class="sum-val blue" id="sumHrs">0hr 0min</div><div class="sum-lbl">Total Hours</div></div>
    <div class="sum-item"><div class="sum-val green" id="sumFree">420</div><div class="sum-lbl">Mins Free</div></div>
    <div class="sum-item">
      <div id="sumStatus" class="status-badge status-ok">‚úÖ On Track</div>
      <div class="sum-lbl" style="margin-top:10px">Status</div>
    </div>
  </div>

  <div class="section-title">Task Breakdown</div>
  <div class="task-grid" id="taskGrid"></div>

  <div class="action-row">
    <button class="btn btn-success" onclick="saveToday()">üíæ Save Today's Record</button>
    <button class="btn btn-secondary" onclick="exportCSV()">‚¨á Export CSV</button>
    <button class="btn btn-secondary" onclick="resetTasks()">‚úï Clear Counts</button>
  </div>

  <div class="section-title">Saved Records</div>
  <div class="history-list" id="historyList"></div>
</div>

<div class="toast" id="toast"></div>

<div class="bottom-bar">
  <div class="bottom-bar-inner">
    <div class="bottom-left">
      <div class="bottom-label">Shift Countdown</div>
      <div class="countdown ok" id="countdown">7:00:00</div>
    </div>
    <div class="bottom-divider"></div>
    <div class="bottom-stat"><div class="bottom-stat-val" id="bottomElapsed">0m</div><div class="bottom-stat-lbl">Elapsed</div></div>
    <div class="bottom-stat"><div class="bottom-stat-val" id="bottomRemain">420m</div><div class="bottom-stat-lbl">Remaining</div></div>
    <div class="bottom-stat"><div class="bottom-stat-val" id="bottomPct">0%</div><div class="bottom-stat-lbl">Shift Used</div></div>
    <div class="bottom-divider"></div>
    <div class="bottom-progress-wrap">
      <div class="bottom-progress-label">Shift Progress</div>
      <div class="bottom-progress-track">
        <div class="bottom-progress-fill ok" id="bottomProgressFill" style="width:0%"></div>
      </div>
    </div>
  </div>
</div>

<script>
const TASKS = [
  { id: 'email',      name: 'Email Follow-Up',   mins: 4  },
  { id: 'bms',        name: 'BMS Follow-Up',      mins: 3  },
  { id: 'indexing',   name: 'Indexing',            mins: 3  },
  { id: 'processing', name: 'Processing',          mins: 5  },
  { id: 'reccomp',    name: 'Rec Comp',            mins: 5  },
  { id: 'inspection', name: 'Inspection Review',   mins: 18 },
];
const SHIFT_MINS = 420, SHIFT_SECS = SHIFT_MINS * 60;
let counts = {}; TASKS.forEach(t => counts[t.id] = 0);
let shiftTimer = null, shiftRunning = false, shiftEndTime = null;

function buildCards() {
  const grid = document.getElementById('taskGrid');
  grid.innerHTML = '';
  TASKS.forEach(t => {
    const isAuto = t.id === 'inspection';
    const card = document.createElement('div');
    card.className = 'task-card' + (isAuto ? ' auto-card' : '');
    const inputBlock = isAuto
      ? `<div style="width:100%">
           <div class="counter-widget auto-widget-editable">
             <button class="counter-btn" onclick="adjustInspection(-1)">‚àí</button>
             <input type="number" class="counter-num" id="inp_${t.id}" value="0" min="0" max="999" oninput="onInspectionInput(this.value)"/>
             <button class="counter-btn" onclick="adjustInspection(1)">+</button>
           </div>
           <div class="auto-reset-row">
             <span class="auto-calc-info" id="autoCalcInfo">‚öô Auto: 0 tasks</span>
             <button class="auto-reset-btn" onclick="resetInspectionToAuto()" title="Reset to auto-calculated value">‚Ü∫ Reset to Auto</button>
           </div>
         </div>`
      : `<div class="counter-widget">
           <button class="counter-btn" onclick="adjust('${t.id}',-1)">‚àí</button>
           <input type="number" class="counter-num" id="inp_${t.id}" value="0" min="0" max="999" oninput="onInput('${t.id}',this.value)"/>
           <button class="counter-btn" onclick="adjust('${t.id}',1)">+</button>
         </div>`;
    card.innerHTML = `
      <div class="task-top">
        <div class="task-name">${t.name}${isAuto ? ' <span class="auto-badge">Auto-fill</span>' : ''}</div>
        <div class="task-rate">${t.mins} min/task</div>
      </div>
      ${isAuto ? '<div class="auto-hint">‚ö° Calculates how many reviews fit in the remaining shift time</div>' : ''}
      <div class="task-input-row">
        <div class="task-count-label">Tasks:</div>
        ${inputBlock}
      </div>
      <div class="task-result">
        <div>
          <div class="task-mins" id="res_mins_${t.id}">0 mins</div>
          <div class="task-hrs" id="res_hrs_${t.id}">0hr 0min</div>
        </div>
        <div style="text-align:right;font-family:'Space Mono',monospace;font-size:0.65rem;color:var(--muted)">
          Max/shift: <span style="color:var(--text2);font-weight:600">${Math.floor(SHIFT_MINS/t.mins)}</span>
        </div>
      </div>
      <div class="task-bar"><div class="task-bar-fill" id="bar_${t.id}" style="width:0%"></div></div>`;
    grid.appendChild(card);
  });
}

function fmtHrMin(m) { return `${Math.floor(m/60)}hr ${m%60}min`; }

function adjust(id, delta) { counts[id] = Math.max(0,(counts[id]||0)+delta); document.getElementById('inp_'+id).value=counts[id]; recalc(); }
function onInput(id, val) { counts[id] = Math.max(0,parseInt(val)||0); recalc(); }

function adjustInspection(delta) {
  inspManualOverride = true;
  counts['inspection'] = Math.max(0, (counts['inspection'] || 0) + delta);
  document.getElementById('inp_inspection').value = counts['inspection'];
  recalc();
}

function onInspectionInput(val) {
  inspManualOverride = true;
  counts['inspection'] = Math.max(0, parseInt(val) || 0);
  recalc();
}

function resetInspectionToAuto() {
  inspManualOverride = false;
  recalc();
}

// Track auto value and whether user has manually overridden
let inspAutoValue = 0;
let inspManualOverride = false;

function recalc() {
  // Calculate mins used by the 5 manual tasks (exclude inspection)
  let manualMins = 0, manualTasks = 0;
  TASKS.filter(t => t.id !== 'inspection').forEach(t => {
    const c = counts[t.id] || 0;
    manualMins += c * t.mins;
    manualTasks += c;
  });

  // Auto-calculate Inspection Review count from remaining time
  const inspTask = TASKS.find(t => t.id === 'inspection');
  const remainingMins = Math.max(0, SHIFT_MINS - manualMins);
  inspAutoValue = Math.floor(remainingMins / inspTask.mins);

  // Only auto-set if user hasn't manually overridden
  if (!inspManualOverride) {
    counts['inspection'] = inspAutoValue;
    document.getElementById('inp_inspection').value = inspAutoValue;
  }

  // Update the auto-info label
  const infoEl = document.getElementById('autoCalcInfo');
  if (infoEl) {
    infoEl.textContent = inspManualOverride
      ? `‚öô Auto: ${inspAutoValue} tasks (overridden)`
      : `‚öô Auto: ${inspAutoValue} tasks`;
    infoEl.style.color = inspManualOverride ? 'var(--warn)' : 'var(--accent)';
  }

  // Now compute totals including auto inspection
  let totalMins = 0, totalTasks = 0;
  TASKS.forEach(t => {
    const c = counts[t.id] || 0, m = c * t.mins;
    totalMins += m; totalTasks += c;
    document.getElementById('res_mins_'+t.id).textContent = m + ' mins';
    document.getElementById('res_hrs_'+t.id).textContent = fmtHrMin(m);
    document.getElementById('bar_'+t.id).style.width = Math.min(100,(m/SHIFT_MINS)*100) + '%';
  });

  const free = SHIFT_MINS - totalMins, pct = (totalMins / SHIFT_MINS) * 100;
  document.getElementById('sumTasks').textContent = totalTasks;
  document.getElementById('sumMins').textContent = totalMins;
  document.getElementById('sumHrs').textContent = fmtHrMin(totalMins);
  document.getElementById('sumFree').textContent = Math.max(0, free);
  document.getElementById('sumFree').className = 'sum-val ' + (free < 0 ? 'red' : free < 60 ? 'yellow' : 'green');
  const prog = document.getElementById('taskProgress'), pctEl = document.getElementById('taskPct');
  prog.style.width = Math.min(100,pct) + '%';
  prog.className = 'progress-fill ' + (pct > 100 ? 'over' : pct > 85 ? 'warn' : 'ok');
  pctEl.textContent = pct.toFixed(1) + '%';
  pctEl.style.color = pct > 100 ? 'var(--accent2)' : pct > 85 ? 'var(--warn)' : 'var(--accent3)';
  const sb = document.getElementById('sumStatus');
  if(pct > 100){sb.className='status-badge status-over';sb.textContent='üî¥ Exceeds Shift';}
  else if(pct > 85){sb.className='status-badge status-warn';sb.textContent='‚ö† Near Limit';}
  else{sb.className='status-badge status-ok';sb.textContent='‚úÖ On Track';}
}

function startShift() {
  if(shiftRunning)return;
  const [h,m]=document.getElementById('shiftStart').value.split(':').map(Number);
  const start=new Date(); start.setHours(h,m,0,0);
  shiftEndTime=new Date(start.getTime()+SHIFT_SECS*1000);
  shiftRunning=true;
  document.getElementById('btnStart').style.display='none';
  document.getElementById('btnReset').style.display='';
  document.getElementById('shiftStart').disabled=true;
  tickShift(); shiftTimer=setInterval(tickShift,1000);
  showToast('Shift started! ‚ñ∂');
}

function tickShift() {
  const now=new Date(), remaining=Math.max(0,Math.round((shiftEndTime-now)/1000)), elapsed=SHIFT_SECS-remaining;
  const fmt=n=>String(n).padStart(2,'0');
  const cd=document.getElementById('countdown');
  cd.textContent=`${fmt(Math.floor(remaining/3600))}:${fmt(Math.floor((remaining%3600)/60))}:${fmt(remaining%60)}`;
  const pct=elapsed/SHIFT_SECS, cls=remaining===0?'over':pct>0.85?'warn':'ok';
  cd.className='countdown '+cls;
  document.getElementById('statElapsed').textContent=Math.round(elapsed/60)+'m';
  document.getElementById('statRemain').textContent=Math.round(remaining/60)+'m';
  document.getElementById('statPct').textContent=(pct*100).toFixed(0)+'%';
  document.getElementById('bottomElapsed').textContent=Math.round(elapsed/60)+'m';
  document.getElementById('bottomRemain').textContent=Math.round(remaining/60)+'m';
  document.getElementById('bottomPct').textContent=(pct*100).toFixed(0)+'%';
  const fill=document.getElementById('bottomProgressFill');
  fill.style.width=Math.min(100,pct*100).toFixed(1)+'%';
  fill.className='bottom-progress-fill '+cls;
  if(remaining===0){clearInterval(shiftTimer);showToast('‚è∞ Shift complete!');}
}

function resetShift() {
  clearInterval(shiftTimer); shiftRunning=false; shiftEndTime=null;
  document.getElementById('countdown').textContent='7:00:00';
  document.getElementById('countdown').className='countdown ok';
  ['statElapsed','statRemain','statPct','bottomElapsed','bottomRemain','bottomPct'].forEach((id,i)=>{
    document.getElementById(id).textContent=['0m','420m','0%','0m','420m','0%'][i];
  });
  document.getElementById('btnStart').style.display='';
  document.getElementById('btnReset').style.display='none';
  document.getElementById('shiftStart').disabled=false;
}

function tickClock() {
  const now=new Date();
  document.getElementById('liveClock').textContent=[now.getHours(),now.getMinutes(),now.getSeconds()].map(n=>String(n).padStart(2,'0')).join(':');
}
setInterval(tickClock,1000); tickClock();

function saveToday() {
  const now=new Date();
  const dateStr=now.toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short',year:'numeric'});
  const timeStr=now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
  let totalMins=0,totalTasks=0; const taskSnap={};
  TASKS.forEach(t=>{taskSnap[t.id]=counts[t.id];totalTasks+=counts[t.id];totalMins+=counts[t.id]*t.mins;});
  const history=getHistory();
  history.unshift({date:dateStr,time:timeStr,counts:taskSnap,totalTasks,totalMins});
  localStorage.setItem('shifttrack_history',JSON.stringify(history.slice(0,30)));
  renderHistory(); showToast('‚úÖ Record saved!');
}

function getHistory(){try{return JSON.parse(localStorage.getItem('shifttrack_history')||'[]');}catch{return[];}}

function renderHistory() {
  const list=document.getElementById('historyList'), history=getHistory();
  if(!history.length){list.innerHTML='<div class="empty-history">No records yet ‚Äî save today\'s shift to start tracking.</div>';return;}
  list.innerHTML=history.map((r,i)=>`
    <div class="history-item">
      <div class="history-date">${r.date} ¬∑ ${r.time}</div>
      <div class="history-tasks">${TASKS.filter(t=>(r.counts[t.id]||0)>0).map(t=>`<span class="history-tag">${t.name.split(' ')[0]}: ${r.counts[t.id]}</span>`).join('')}</div>
      <div class="history-total">${r.totalMins}m ¬∑ ${r.totalTasks} tasks</div>
      <button class="history-del" onclick="deleteRecord(${i})">‚úï</button>
    </div>`).join('');
}

function deleteRecord(i){const h=getHistory();h.splice(i,1);localStorage.setItem('shifttrack_history',JSON.stringify(h));renderHistory();}

function exportCSV() {
  const history=getHistory();
  if(!history.length){showToast('No records to export yet.');return;}
  let csv='Date,Time,'+TASKS.map(t=>t.name).join(',')+',Total Tasks,Total Mins,Total Hours\n';
  history.forEach(r=>{csv+=`"${r.date}","${r.time}",`+TASKS.map(t=>r.counts[t.id]||0).join(',')+`,${r.totalTasks},${r.totalMins},${(r.totalMins/60).toFixed(2)}\n`;});
  const blob=new Blob([csv],{type:'text/csv'}),url=URL.createObjectURL(blob),a=document.createElement('a');
  a.href=url;a.download='ShiftTrack_Records.csv';a.click();URL.revokeObjectURL(url);
  showToast('‚¨á CSV downloaded!');
}

function resetTasks(){TASKS.forEach(t=>{counts[t.id]=0;document.getElementById('inp_'+t.id).value=0;});recalc();showToast('Counts cleared.');}

let toastTimer;
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('show'),2500);}

buildCards(); recalc(); renderHistory();
</script>
</body>
</html>
